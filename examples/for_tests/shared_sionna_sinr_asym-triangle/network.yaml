# MANET Shared Bridge with SINR - Asymmetric Geometry (Connectivity Test)
#
# This example demonstrates:
# - 3-node MANET with shared broadcast domain (Linux bridge)
# - SINR computation with co-channel interference
# - Non-equilateral triangle geometry for positive SINR
# - Suitable modulation (16-QAM) for SINR ~12-15 dB
#
# Topology:
#   node1 (0, 0, 1) ------ 30m ------ node2 (30, 0, 1)
#                \                    /
#              91.2m              91.2m
#                  \              /
#                   node3 (15, 90, 1)
#
# Geometry Analysis:
# - node1→node2: 30m (signal path)
# - node1→node3: 91.2m (interference path, much weaker)
# - node2→node3: 91.2m (interference path, much weaker)
# - Asymmetric: Signal much stronger than interference
# - Expected SINR: ~9-10 dB (vs 0 dB for equilateral)
#
# Expected SINR Calculation:
# For link node1→node2:
#   - Signal power: -52.0 dBm (20 dBm TX - 72 dB path loss at 30m)
#   - Noise power: -88.0 dBm (thermal noise floor)
#   - SNR: 36.0 dB
#   - Interference from node3:
#     * Path loss at 91.2m: ~81.7 dB
#     * Interference power: -61.7 dBm (20 dBm - 81.7 dB)
#   - SINR = Signal / (Noise + Interference)
#   - SINR ≈ 9-10 dB (suitable for QPSK with LDPC)

name: manet-asymmetric-sinr

topology:
  enable_sinr: true  # Enable SINR computation with interference

  scene:
    file: scenes/vacuum.xml

  shared_bridge:
    enabled: true
    name: manet-asym-br0
    nodes: [node1, node2, node3]
    interface_name: eth1

  nodes:
    # Node 1: WiFi 6 at 5.18 GHz (Channel 36)
    node1:
      kind: linux
      image: alpine:latest
      exec:
        - apk add --no-cache iproute2 iputils iperf3
      interfaces:
        eth1:
          ip_address: 192.168.100.1/24
          wireless:
            position:
              x: 0
              y: 0
              z: 1
            frequency_ghz: 5.18          # Channel 36
            bandwidth_mhz: 80
            rf_power_dbm: 20.0
            rx_sensitivity_dbm: -80.0    # WiFi 6 receiver sensitivity

            # Antenna configuration
            antenna_pattern: hw_dipole  # Half-wave dipole (2.16 dBi)
            polarization: V

            # Modulation: QPSK suitable for SINR ~8-12 dB
            modulation: qpsk
            fec_type: ldpc
            fec_code_rate: 0.5

    # Node 2: WiFi 6 at 5.18 GHz (co-channel with node1)
    node2:
      kind: linux
      image: alpine:latest
      exec:
        - apk add --no-cache iproute2 iputils iperf3
      interfaces:
        eth1:
          ip_address: 192.168.100.2/24
          wireless:
            position:
              x: 30
              y: 0
              z: 1
            frequency_ghz: 5.18          # Co-channel with node1
            bandwidth_mhz: 80
            rf_power_dbm: 20.0
            rx_sensitivity_dbm: -80.0

            antenna_pattern: hw_dipole  # Half-wave dipole (2.16 dBi)
            polarization: V

            modulation: qpsk
            fec_type: ldpc
            fec_code_rate: 0.5

    # Node 3: WiFi 6 at 5.18 GHz (moved further away for asymmetric geometry)
    node3:
      kind: linux
      image: alpine:latest
      exec:
        - apk add --no-cache iproute2 iputils iperf3
      interfaces:
        eth1:
          ip_address: 192.168.100.3/24
          wireless:
            position:
              x: 15
              y: 90    # Moved far away for sufficient SINR (was 25.98)
              z: 1
            frequency_ghz: 5.18          # Co-channel with node1/node2
            bandwidth_mhz: 80
            rf_power_dbm: 20.0
            rx_sensitivity_dbm: -80.0

            antenna_pattern: hw_dipole  # Half-wave dipole (2.16 dBi)
            polarization: V

            modulation: qpsk
            fec_type: ldpc
            fec_code_rate: 0.5

# Expected Behavior:
#
# SINR Calculation (Asymmetric Geometry):
# - All nodes on same frequency (5.18 GHz, co-channel)
# - Non-equilateral triangle: interference paths (91.2m) >> signal paths (30m)
# - Expected SINR: ~9-10 dB (positive SINR suitable for QPSK connectivity)
#
# Link node1→node2:
#   - Signal: 30m, path loss ~72 dB, power = -52 dBm
#   - Interference from node3: 91.2m, path loss ~81.7 dB, power = -61.7 dBm
#   - SNR: 36.0 dB
#   - SINR: ~9-10 dB (9.7 dB improvement from interference being weaker)
#   - QPSK with LDPC should work (min SINR ~8 dB)
#
# Link node2→node1:
#   - Same geometry, symmetric SINR
#
# Link node1→node3:
#   - Signal: 91.2m, path loss ~81.7 dB, power = -61.7 dBm
#   - Interference from node2: 30m, path loss ~72 dB, power = -52 dBm
#   - SNR: 26.3 dB
#   - SINR: ~-3 to -4 dB (interference MUCH STRONGER than signal)
#   - Expected 100% packet loss on this link (negative SINR)
#
# Link node2→node3:
#   - Signal: 91.2m, path loss ~81.7 dB, power = -61.7 dBm
#   - Interference from node1: 30m, path loss ~72 dB, power = -52 dBm
#   - SINR: ~-3 to -4 dB
#   - Expected 100% packet loss on this link (negative SINR)
#
# Deployment:
#   sudo $(which uv) run sine deploy examples/for_tests/shared_sionna_sinr_asymmetric/network.yaml
#
# Expected output:
#   Link: node1→node2 [wireless, SINR enabled]
#     SNR: 36.0 dB | SINR: 9-10 dB | Interferers: 1 (node3)
#     Loss: 0-5% | Rate: ~50-64 Mbps (QPSK)
#
#   Link: node1→node3 [wireless, SINR enabled]
#     SNR: 26.3 dB | SINR: -3 to -4 dB | Interferers: 1 (node2)
#     Loss: 100% | Rate: 0 Mbps (negative SINR, no connectivity)
#
# Validation:
#   - SINR varies dramatically by link (asymmetric geometry)
#   - Short links (30m): Good SINR (~9-10 dB), low loss, good connectivity
#   - Long links (91.2m): Negative SINR (~-3 to -4 dB), 100% loss, no connectivity
#   - Connectivity: ONLY node1↔node2 should ping successfully
#   - node3 links: NO CONNECTIVITY (interference >> signal)
#
# Test Commands:
#   # Test connectivity (should succeed for node1↔node2)
#   docker exec clab-manet-asymmetric-sinr-node1 ping -c 10 192.168.100.2
#
#   # Test throughput (node1→node2)
#   docker exec -d clab-manet-asymmetric-sinr-node2 iperf3 -s
#   docker exec clab-manet-asymmetric-sinr-node1 iperf3 -c 192.168.100.2 -t 10
#
#   # Expect: 50-64 Mbps for node1↔node2 (good SINR ~9-10 dB with QPSK)
#   # Expect: 0 Mbps for node1↔node3, node2↔node3 (negative SINR, no connectivity)
