# CSMA + Adaptive MCS Integration Test - Linear Topology
#
# This topology tests that MCS selection uses SINR (not SNR) when a CSMA MAC model
# is present. This ensures that interference is properly accounted for in modulation
# selection.
#
# Expected behavior:
# - Node2 ↔ Node3: Primary link with iperf traffic (node2 → node3)
# - Node1: Interferer that degrades SINR at node3
# - Node2's MCS to node3 should be selected based on SINR (not SNR)
# - With 30% traffic load, node1 creates measurable interference
#
# Test topology (linear arrangement):
#
#   node1 ──────────────── node2 ────── node3
#   (0,0,1)              (30,0,1)   (40,0,1)
#
#   Distances:
#   - node1 ↔ node2: 30m (OUTSIDE CS range → hidden node)
#   - node2 ↔ node3: 10m (primary test link)
#   - node1 ↔ node3: 40m
#
#   Expected SINR values (measured from actual deployment):
#   - node2→node3: 17.3 dB ✅ (primary test link)
#   - node3→node2: 14.8 dB ✅ (reverse direction)
#   - node2→node1: 31.7 dB ✅ (minimal interference)
#   - node3→node1: 29.2 dB ✅ (minimal interference)
#   - node1→node2: -4.3 dB ❌ (NEGATIVE! Cannot transmit)
#   - node1→node3: -6.8 dB ❌ (NEGATIVE! Cannot transmit)
#
#   Key finding: node1 CANNOT successfully transmit due to interference from
#   node2 and node3 overwhelming its signal. This is the hidden node problem:
#   node1 is outside the carrier sense range (30m > 27.5m CS range), so it
#   transmits without sensing node2/node3, but its transmissions fail due to
#   negative SINR.
#
# Note: This topology demonstrates asymmetric connectivity. Links TO node1 work
# (positive SINR), but links FROM node1 fail (negative SINR).
#
# All nodes co-channel (5.18 GHz), all transmit with CSMA model

name: sh-sio-sinr-csma-mcs

topology:
  # Enable SINR computation (interference modeling)
  enable_sinr: true

  # Scene configuration (vacuum for free-space propagation)
  scene:
    file: scenes/vacuum.xml

  # Shared bridge for MANET broadcast domain
  shared_bridge:
    enabled: true
    name: csma-mcs-br0
    nodes: [node1, node2, node3]
    interface_name: eth1

  nodes:
    # Node 1: WiFi 6 with CSMA + Adaptive MCS
    node1:
      kind: linux
      image: alpine:latest
      exec:
        - apk add --no-cache iproute2 iputils iperf3
      interfaces:
        eth1:
          ip_address: 192.168.100.1/24
          wireless:
            # Physical layer
            position: {x: 0, y: 0, z: 1}  # Interferer, will be hidden from node2
            frequency_ghz: 5.18          # WiFi 6 channel 36
            bandwidth_mhz: 80            # 80 MHz channel
            rf_power_dbm: 20             # 100 mW (typical WiFi 6)

            # Antenna configuration
            antenna_pattern: iso         # Isotropic (omnidirectional, 0.0 dBi)
            polarization: V              # Vertical polarization

            # Adaptive MCS selection (key test feature)
            mcs_table: examples/common_data/wifi6_mcs.csv
            mcs_hysteresis_db: 2.0

            # MAC layer: CSMA/CA model
            csma:
              enabled: true                          # Enable CSMA/CA model
              carrier_sense_range_multiplier: 2.5    # CS range = 2.5× communication range
              traffic_load: 0.3                      # 30% duty cycle
              communication_range_snr_threshold_db: 40.4  # Gives comm_range=11m, CS_range=27.5m (node1 @ 30m is hidden)

    # Node 2: WiFi 6 client (primary receiver)
    node2:
      kind: linux
      image: alpine:latest
      exec:
        - apk add --no-cache iproute2 iputils iperf3
      interfaces:
        eth1:
          ip_address: 192.168.100.2/24
          wireless:
            position: {x: 30, y: 0, z: 1}  # 30m from node1 (should be hidden with proper SNR threshold)
            frequency_ghz: 5.18
            bandwidth_mhz: 80
            rf_power_dbm: 20
            antenna_pattern: iso  # Isotropic (0.0 dBi)
            polarization: V
            mcs_table: examples/common_data/wifi6_mcs.csv
            mcs_hysteresis_db: 2.0

            # Same CSMA config
            csma:
              enabled: true
              carrier_sense_range_multiplier: 2.5
              traffic_load: 0.3
              communication_range_snr_threshold_db: 40.4  # Gives comm_range=11m, CS_range=27.5m (node1 @ 30m is hidden)

    # Node 3: Interferer (creates SINR degradation)
    node3:
      kind: linux
      image: alpine:latest
      exec:
        - apk add --no-cache iproute2 iputils iperf3
      interfaces:
        eth1:
          ip_address: 192.168.100.3/24
          wireless:
            position: {x: 40, y: 0, z: 1}  # 40m from node1, 10m from node2
            frequency_ghz: 5.18
            bandwidth_mhz: 80
            rf_power_dbm: 20
            antenna_pattern: iso  # Isotropic (0.0 dBi)
            polarization: V
            mcs_table: examples/common_data/wifi6_mcs.csv
            mcs_hysteresis_db: 2.0

            csma:
              enabled: true
              carrier_sense_range_multiplier: 2.5
              traffic_load: 0.3
              communication_range_snr_threshold_db: 40.4  # Gives comm_range=11m, CS_range=27.5m (node1 @ 30m is hidden)

# Expected Results (actual measured SINR values):
#
# Primary test link (node2 ↔ node3):
# - node2→node3: SNR=41.2 dB, SINR=17.3 dB (interference from node1)
# - node3→node2: SNR=41.2 dB, SINR=14.8 dB (interference from node1)
# - MCS selection: Based on SINR ~15-17 dB → MCS 4 (16-QAM rate-0.75)
# - Both directions functional with moderate interference
#
# Links TO node1 (functional):
# - node2→node1: SNR=31.7 dB, SINR=31.7 dB (minimal interference from node3)
# - node3→node1: SNR=29.2 dB, SINR=29.2 dB (minimal interference from node2)
# - Both links work well (positive SINR)
#
# Links FROM node1 (FAILED - negative SINR):
# - node1→node2: SNR=31.7 dB, SINR=-4.3 dB ❌ (interference >> signal)
# - node1→node3: SNR=29.2 dB, SINR=-6.8 dB ❌ (interference >> signal)
# - Node1 cannot transmit successfully (hidden node problem)
# - Interference from node2/node3 overwhelms node1's signal
#
# Key insights:
# 1. ASYMMETRIC CONNECTIVITY: Links to node1 work, links from node1 fail
# 2. Hidden node problem: node1 outside CS range but creates/receives interference
# 3. SINR can be NEGATIVE when interference > signal power
# 4. MCS selection MUST use SINR (not SNR) to account for interference
# 5. Topology geometry determines interference patterns
#
# Validation criteria:
# 1. node2↔node3 connectivity works (SINR ~15-17 dB)
# 2. [node2,node3]→node1 connectivity works (SINR ~30 dB)
# 3. node1→[node2,node3] connectivity FAILS (SINR negative)
# 4. Test validates selective connectivity (asymmetric links)
#
# Deployment:
#   UV_PATH=$(which uv) sudo -E $(which uv) run sine deploy \
#     examples/for_tests/shared_sionna_sinr_csma-mcs/network.yaml
#
# Expected deployment output:
#   node2→node3: SINR=17.3 dB, MCS 4 (16-QAM rate-0.75), Rate ~192 Mbps
#   node3→node2: SINR=14.8 dB, MCS 4 (16-QAM rate-0.75), Rate ~192 Mbps
#   node1→node2: SINR=-4.3 dB, Loss ~100% (negative SINR!)
#   node1→node3: SINR=-6.8 dB, Loss ~100% (negative SINR!)
