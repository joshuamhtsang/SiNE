# CSMA + Adaptive MCS Integration Test - Linear Topology
#
# This topology tests that MCS selection uses SINR (not SNR) when a CSMA MAC model
# is present. This ensures that interference is properly accounted for in modulation
# selection.
#
# Expected behavior:
# - Node2 ↔ Node3: Primary link with iperf traffic (node2 → node3)
# - Node1: Interferer that degrades SINR at node3
# - Node2's MCS to node3 should be selected based on SINR (not SNR)
# - With 30% traffic load, node1 creates measurable interference
#
# Test topology (linear arrangement):
#
#   node1 ──────────────── node2 ────── node3
#   (0,0,1)              (30,0,1)   (40,0,1)
#
#   Distances:
#   - node1 ↔ node2: 30m (OUTSIDE CS range → hidden node)
#   - node2 ↔ node3: 10m (primary test link)
#   - node1 ↔ node3: 40m
#
#   Expected SINR computation @ node3:
#   - Signal from node2 (10m): ~-47 dBm
#   - Interference from node1 (40m, 30% prob): ~-64 dBm effective
#   - Noise floor: -88.0 dBm
#   - SNR: ~41 dB (signal-to-noise, no interference)
#   - SINR: < SNR (interference-limited!)
#   - node1 is HIDDEN from node2 (30m > 27.5m CS range)
#
# Note: With this spacing, interference dominates. The test validates that MCS
# is selected on SINR (11 dB) not SNR (42 dB), demonstrating correct SINR-based
# MCS selection.
#
# All nodes co-channel (5.18 GHz), all transmit with CSMA model

name: csma-mcs-test

topology:
  # Scene configuration (vacuum for free-space propagation)
  scene:
    file: scenes/vacuum.xml

  # Shared bridge for MANET broadcast domain
  shared_bridge:
    enabled: true
    name: csma-mcs-br0
    nodes: [node1, node2, node3]
    interface_name: eth1

  nodes:
    # Node 1: WiFi 6 with CSMA + Adaptive MCS
    node1:
      kind: linux
      image: alpine:latest
      exec:
        - apk add --no-cache iproute2 iputils iperf3
      interfaces:
        eth1:
          ip_address: 192.168.100.1/24
          wireless:
            # Physical layer
            position: {x: 0, y: 0, z: 1}  # Interferer, will be hidden from node2
            frequency_ghz: 5.18          # WiFi 6 channel 36
            bandwidth_mhz: 80            # 80 MHz channel
            rf_power_dbm: 20             # 100 mW (typical WiFi 6)

            # Antenna configuration
            antenna_pattern: iso         # Isotropic (omnidirectional)
            polarization: V              # Vertical polarization
            antenna_gain_dbi: 0.0        # 0 dBi (omnidirectional)

            # Adaptive MCS selection (key test feature)
            mcs_table: examples/common_data/wifi6_mcs.csv
            mcs_hysteresis_db: 2.0

            # MAC layer: CSMA/CA model
            csma:
              enabled: true                          # Enable CSMA/CA model
              carrier_sense_range_multiplier: 2.5    # CS range = 2.5× communication range
              traffic_load: 0.3                      # 30% duty cycle
              communication_range_snr_threshold_db: 40.4  # Gives comm_range=11m, CS_range=27.5m (node1 @ 30m is hidden)

    # Node 2: WiFi 6 client (primary receiver)
    node2:
      kind: linux
      image: alpine:latest
      exec:
        - apk add --no-cache iproute2 iputils iperf3
      interfaces:
        eth1:
          ip_address: 192.168.100.2/24
          wireless:
            position: {x: 30, y: 0, z: 1}  # 30m from node1 (should be hidden with proper SNR threshold)
            frequency_ghz: 5.18
            bandwidth_mhz: 80
            rf_power_dbm: 20
            antenna_pattern: iso
            polarization: V
            antenna_gain_dbi: 0.0
            mcs_table: examples/common_data/wifi6_mcs.csv
            mcs_hysteresis_db: 2.0

            # Same CSMA config
            csma:
              enabled: true
              carrier_sense_range_multiplier: 2.5
              traffic_load: 0.3
              communication_range_snr_threshold_db: 40.4  # Gives comm_range=11m, CS_range=27.5m (node1 @ 30m is hidden)

    # Node 3: Interferer (creates SINR degradation)
    node3:
      kind: linux
      image: alpine:latest
      exec:
        - apk add --no-cache iproute2 iputils iperf3
      interfaces:
        eth1:
          ip_address: 192.168.100.3/24
          wireless:
            position: {x: 40, y: 0, z: 1}  # 40m from node1, 10m from node2
            frequency_ghz: 5.18
            bandwidth_mhz: 80
            rf_power_dbm: 20
            antenna_pattern: iso
            polarization: V
            antenna_gain_dbi: 0.0
            mcs_table: examples/common_data/wifi6_mcs.csv
            mcs_hysteresis_db: 2.0

            csma:
              enabled: true
              carrier_sense_range_multiplier: 2.5
              traffic_load: 0.3
              communication_range_snr_threshold_db: 40.4  # Gives comm_range=11m, CS_range=27.5m (node1 @ 30m is hidden)

# Expected Results (with SINR fix):
#
# Link node2 → node3 (20m free-space):
# - Signal power: -52.7 dBm (from node2 @ 20m)
# - Interference: -64.0 dBm effective (from node1 @ 40m, 30% traffic load)
# - Noise floor: -95.0 dBm
# - SNR: 42.2 dB (signal-to-noise, no interference)
# - SINR: 11.3 dB (interference-limited! I >> N)
# - Degradation: 31 dB (demonstrates large interference impact)
#
# MCS Selection:
# - Without fix: MCS selected on SNR=42 dB → MCS 10 or 11 (1024-QAM)
# - With fix: MCS selected on SINR=11 dB → MCS 2 (QPSK rate-0.75)
# - This shows the CRITICAL IMPORTANCE of using SINR for MCS selection!
#
# Validation criteria:
# 1. SINR << SNR (interference dominates)
# 2. MCS index matches SINR threshold (~11 dB), not SNR
# 3. Deployment summary shows both SNR and SINR values
# 4. MAC model type shown as "csma"
# 5. SINR degradation is large (>20 dB) due to strong interference
#
# Deployment:
#   sudo $(which uv) run sine deploy --enable-mobility examples/csma_mcs_test/network.yaml
#
# Expected output:
#   Link: node2 (eth1) <-> node3 (eth1) [wireless]
#     SNR: 42.2 dB | SINR: 11.3 dB (interference-limited) [CSMA]
#     MCS: 2 (selected on SINR, qpsk rate-0.75 ldpc)
#     Delay: 0.07 ms | Jitter: 0.00 ms | Loss: ~0.1% | Rate: ~72 Mbps
